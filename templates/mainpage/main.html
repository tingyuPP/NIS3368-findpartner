{% load static %}
<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>笔记详情</title>
        <link rel="stylesheet" href="{% static 'css/main.css'%}" />
        <link rel="stylesheet" href="{% static 'css/pushbutton.css'%}" />
        <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}" />
    </head>

    <body>
        <div class="note-detail-mask">
            <div class="note-container">
                <div class="media-container">
                    <div class="carousel">
                        <div class="carousel-item">
                            <img src="{{ post.image }}" alt="图片" />
                        </div>
                    </div>
                </div>
                <div class="interaction-container">
                    <div class="author-container">
                        <div class="author-me">
                            <div class="info">
                                <a href="/my/{{ author.id }}/">
                                    <img
                                        class="avatar-item"
                                        src="{{ author.image }}"
                                        alt="头像"
                                    />
                                </a>
                                <span class="name">{{ author.nickname }}</span>
                            </div>
                        </div>
                        <div class="note-scroller">
                            <div class="note-content">
                                <div class="title">{{ post.title }}</div>
                                <div class="desc">
                                    <span>{{ post.description }} <br /></span>
                                    {% for tag in post.tag %}
                                    <a class="tag tag-search">#{{ tag }}</a>
                                    {% endfor %}
                                </div>
                                <div class="bottom-container">
                                    <span class="date">{{ post.time }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <a
                        href="javascript:;"
                        class="invite-button"
                        onclick="sendmyinvitation()"
                        >发送邀请</a
                    >
                    <button class="disable-button">
                        <svg class="delete-svgIcon" viewBox="0 0 448 512">
                            <path
                                d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"
                            ></path>
                        </svg>
                    </button>
                    <div class="tooltip" id="delete-tooltip">
                        点击后，该找搭子需求将被挂起，对其他用户不可见。
                    </div>
                    <div class="tooltip" id="recover-tooltip">
                        点击后，该找搭子需求将被恢复正常可见状态。
                    </div>
                    <button class="list-button" onclick="viewApplyList()">
                        查看申请列表
                    </button>
                    <button class="recover-button">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            fill="currentColor"
                            class="bi bi-arrow-repeat"
                            viewBox="0 0 16 16"
                        >
                            <path
                                d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"
                            ></path>
                            <path
                                fill-rule="evenodd"
                                d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z"
                            ></path>
                        </svg>
                        恢复需求
                    </button>
                </div>
            </div>
            <div class="close-cricle" onclick="closeNoteDetail()">
                <div class="close close-mask-white">
                    <span class="close-icon">✖️</span>
                </div>
            </div>
        </div>
    </body>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const isMyself = {{ is_myself|yesno:"true,false" }};
            const is_disabled = {{ is_disabled|yesno:"true,false" }};
            console.log(isMyself);
            if (isMyself) {
                document.querySelector(".invite-button").style.display = "none";
                if (is_disabled) {
                    document.querySelector(".disable-button").style.display = "none";
                    document.querySelector(".list-button").style.display = "none";
                } else {
                    document.querySelector(".recover-button").style.display = "none";
                }
            } else {
                document.querySelector(".disable-button").style.display = "none";
                document.querySelector(".list-button").style.display = "none";
                document.querySelector(".recover-button").style.display = "none";
            }

            // 添加鼠标悬停事件监听器
            const disableButton = document.querySelector('.disable-button');
            const delete_tooltip = document.getElementById('delete-tooltip');
            const recover_tooltip = document.getElementById('recover-tooltip');
            const recoverButton = document.querySelector('.recover-button');

            disableButton.addEventListener('mouseover', function () {
                const rect = disableButton.getBoundingClientRect();
                delete_tooltip.style.display = 'block';
            });

            disableButton.addEventListener('mouseout', function () {
                delete_tooltip.style.display = 'none';
            });

            disableButton.addEventListener('click', function () {
                const noticeId = "{{ post.id }}"; // 替换为实际的notice_id
                fetch("/api/disable_notice", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ notice_id: noticeId }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success === 0) {
                            alert("挂起成功");
                        } else if (data.success === -1) {
                            alert("未登录");
                        } else if (data.success === -2) {
                            alert("无权限删除");
                        } else {
                            alert("删除失败");
                        }
                        location.reload(); // 刷新页面
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
            });

            recoverButton.addEventListener('mouseover', function () {
                const rect = disableButton.getBoundingClientRect();
                recover_tooltip.style.display = 'block';
            });

            recoverButton.addEventListener('mouseout', function () {
                recover_tooltip.style.display = 'none';
            });

            recoverButton.addEventListener('click', function () {
                const noticeId = "{{ post.id }}"; // 替换为实际的notice_id
                fetch("/api/recover_notice", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ notice_id: noticeId }),
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success === 0) {
                            alert("恢复成功");
                        } else if (data.success === -1) {
                            alert("未登录");
                        } else if (data.success === -2) {
                            alert("无权限恢复");
                        } else {
                            alert("恢复失败");
                        }
                        location.reload(); // 刷新页面
                    })
                    .catch((error) => {
                        console.error("Error:", error);
                    });
            });
        });

        function viewApplyList() {
              // 更新浏览器地址栏
            history.pushState(null, null, `/applylist/{{ post.id }}/`);

             //刷新页面
            location.reload();
        }

        function closeNoteDetail() {
            history.back();
        }
        window.addEventListener("popstate", function (event) {
            location.reload(); // 刷新页面
        });
        function sendmyinvitation() {
            const noticeId = "{{ post.id }}"; // 替换为实际的notice_id

            fetch("/api/request_notice", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ notice_id: noticeId }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success === 0) {
                        alert("请求成功");
                    } else if (data.success === -1) {
                        alert("用户不存在");
                    } else if (data.success === -2) {
                        alert("需求不存在");
                    } else {
                        alert("请求失败");
                    }
                })
                .catch((error) => {
                    console.error("Error:", error);
                });
        }
    </script>
</html>
