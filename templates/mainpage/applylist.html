{% load static %}

<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/message.css' %}">
    <title>消息查看</title>
    <link rel="shortcut icon" href="{% static 'images/favicon.ico' %}">
</head>

<body>
    <div class="background">
        <ul class="message-container">
            {% for user, request_state, post_id in user_list %}
            <li class="message-item">
                <a class="user-avatar" href="/my/{{ user.id }}/">
                    <img class="avatar-item" src="{{ user.image }}" alt="用户头像">
                </a>
                <div class="main">
                    <div class="info">
                        <div class="user-info">
                            <a class="username">{{ user.nickname }}</a>
                        </div>
                        <div class="interaction-content">
                            <span>向你发送了搭子邀请</span>
{#                            <span>{{ request_state }}</span>#}
                            {# <div class="msg-count">!</div> #}
                        </div>
                    </div>
                    {% if request_state == 0 %}
                    <div class="button-container">
                        <button type="button" class="button" onclick="answerRequest('{{ user.id }}', '{{ post_id }}', '1')">同意</button>
                        <button type="button" class="button" onclick="answerRequest('{{ user.id }}', '{{ post_id }}', '2')">拒绝</button>
                    </div>
                    {% elif request_state == 1 %}
                        <div class="interaction-content">
                            <span>已接受</span>
                        </div>
                    {% elif request_state == 2 %}
                        <div class="interaction-content">
                            <span>已拒绝</span>
                        </div>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
    
    <script>
        function acceptInvitation(userId) {
            answerRequest(userId, 'accept');
        }

        function rejectInvitation(userId) {
            answerRequest(userId, 'reject');
        }

        function answerRequest(user_id, post_id, action) {
            fetch('/answer_request/', {  // 使用定义的路径
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'  // 确保包含 CSRF token
                },
                body: new URLSearchParams({
                    'user_id': user_id,
                    'post_id': post_id,
                    'action': action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();  // 刷新页面
                } else {
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('发生错误，请重试');
            });
        }
    </script>
</body>

</html>
